<tool id="crossmap" name="CrossMap" version="0.2.2-0">
    <description>Convert genome coordinates or annotation files between genome assemblies</description>
    
    <requirements>
        <requirement type="package" version="324">ucsc-wigtobigwig</requirement>
        <requirement type="package" version="0.2.2">crossmap</requirement>
    </requirements>
    
    <stdio>
        <regex match="Aborted (core dumped)" source="stdout" level="fatal"/>
        <regex match=".*" source="both" level="log"/>
        <exit_code range="1:"/>
    </stdio>
    
    <version_command>CrossMap.py 2&gt;&amp;1 | head -n 1 | grep -E --only-matching 'CrossMap.*'</version_command>
    
    <command><![CDATA[
      
            #set $input_file = str($seq_source.input)

        CrossMap.py wig
            '${seq_source.input_chain}'
            '${input_file}'
            '${output}'
            
            && mv '${output}.bw' '${output}'
            && mv '${output}.sorted.bgr' '${output2}'
    ]]></command>

    <inputs>
        <conditional name="seq_source">
            <param name="index_source" type="select" label="Source for LiftOver Data (chain file)">
                <option value="cached">Local data (in galaxy)</option>
                <option value="history">From History</option>
            </param>
            <when value="cached">
                <param format="wig" name="input" type="data" label="Wiggle file">
                    <validator type="unspecified_build"/>
                    <!-- Gives error in tests
                    <validator type="dataset_metadata_in_file" filename="liftOver.loc" metadata_name="dbkey" metadata_column="0" message="LiftOver mapping (chain file) is not available for the specified build."/>
                    -->
                </param>
                <param name="input_chain" type="select" label="Lift Over To">
                    <options from_file="liftOver.loc">
                        <column name="name" index="1"/>
                        <column name="value" index="2"/>
                        <column name="dbkey" index="0"/>
                        <filter type="data_meta" ref="input" key="dbkey" column="0"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param format="wig" name="input" type="data" label="Wiggle file"/>
                <param type="data" format="csv" name="input_chain" label="LiftOver chain file"/>
            </when>
        </conditional>
    </inputs>
    
    <outputs>
        <data format="wig" name="output" label="${tool.name} on ${on_string}" />
        <data format="wig" name="output2" label="${tool.name} (bedgraph) on ${on_string}" />
    </outputs>
    
    <tests>
    <!-- WIG - Doesn't understand fixedStep -->
        <test>
            <param name="index_source" value="history"/>
            <param name="input" value="test_wig_01_input_a.wig" ftype="wig"/>
            <param name="input_chain" value="aToB.over.chain" ftype="csv"/>
            
            <output name="output" file="test_wig_01_output_a.bw"/>
            <output name="output2" file="test_wig_01_output_a.sorted.bgr"/>
        </test>
    </tests>
    <help>
CrossMap is versatile tool to convert genome coordinates or annotation files between genome
assemblies. It supports mostly commonly used file types, including BAM, BED,BigWig, GFF,
GTF, SAM, Wiggle, and VCF formats. For large plain text file types, such as BED, GFF, GTF
and VCF, reading from remote servers and file compression are supported.

CrossMap bed
------------
BED format file must have at least 3 columns (chrom, start, end) and no more than 12 columns.
BED format: http://genome.ucsc.edu/FAQ/FAQformat.html#format1
    </help>
    
    <citations>
        <citation type="doi">10.1093/bioinformatics/btt730</citation>
    </citations>
</tool>
